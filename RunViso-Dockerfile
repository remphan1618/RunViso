# Base Image: Jupyter Base Notebook with Python 3.10
FROM jupyter/base-notebook:python-3.10

LABEL maintainer="remphan1618"
LABEL description="RunViso Runtime: Jupyter (Python 3.10), KasmVNC, Caddy, Supervisor on Jupyter Base Image."

# The base image sets up the user 'jovyan'. Switch to root for installations.
USER root

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
# Set locale (often inherited, but good practice)
ENV LANG=C.UTF-8
# Set KasmVNC version globally (Updated to 1.3.4)
ENV KASM_VNC_VERSION=1.3.4

# Install essential system packages NOT included in the base image:
# supervisor: For process management
# gnupg: For adding Caddy repo key
# KasmVNC dependencies: Based on common requirements (libwebp7 for Ubuntu 22.04 base used by recent jupyter images)
# Caddy: Web server (installed separately below)
# x11vnc, xvfb, xterm: For VNC server
# curl: Needed for downloading keys/installers
# Note: git, wget are typically in the base image.
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    supervisor \
    gnupg \
    # KasmVNC / X11 Dependencies
    libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 \
    libxcomposite1 libxcursor1 libxdamage1 libxrandr2 libxtst6 libnss3 libcups2 libxss1 libxrender1 \
    libasound2 libpangocairo-1.0-0 libatk1.0-0 libatk-bridge2.0-0 libgtk-3-0 libgbm1 libglib2.0-0 \
    libjpeg-turbo8 libwebp7 libfontconfig1 \
    x11vnc \
    xvfb \
    xterm \
    # Clean up apt cache immediately after primary install
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Caddy (apt-get update is run here)
RUN curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg \
    && curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list \
    && apt-get update && apt-get install -y caddy \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install KasmVNC using curl (Updated to v1.3.4)
# Hardcode the full URL directly in the curl command
RUN curl -fL "https://github.com/kasmtech/KasmVNC/releases/download/v1.3.4/kasmvnc_ubuntu_jammy_1.3.4_amd64.deb" -o /tmp/kasmvnc.deb && \
    # Run apt-get update *before* installing the local deb
    apt-get update && \
    apt-get install -y --no-install-recommends /tmp/kasmvnc.deb && \
    rm /tmp/kasmvnc.deb && \
    # Clean up apt cache again
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --- Miniconda installation is NO LONGER NEEDED ---
# The base image already includes Conda (with Python 3.10) and sets up the PATH

# Set up directories needed by Supervisor and ensure correct permissions
# /workspace: Standard Vast.ai persistent volume mount point (already exists in base image, owned by jovyan)
# /var/log/supervisor: Centralized logging directory
RUN mkdir -p /var/log/supervisor && \
    chown -R ${NB_USER}:${NB_GID} /var/log/supervisor && \
    # Ensure /workspace exists and has correct ownership (should be okay from base image)
    mkdir -p /workspace && \
    chown ${NB_USER}:${NB_GID} /workspace

# Copy configuration files
# Assumes these files are in the same directory as the Dockerfile (build context root)
COPY RunViso-Supervisord.conf /etc/supervisor/conf.d/RunViso-Supervisord.conf
COPY RunViso-Caddyfile /etc/caddy/Caddyfile

# Copy the setup notebook to the default user's workspace
# Use NB_USER variable from base image (default: jovyan)
COPY --chown=${NB_USER}:${NB_GID} RunViso-SetupGuide.ipynb /home/${NB_USER}/RunViso-SetupGuide.ipynb

# Default KasmVNC port
EXPOSE 6901
# Default Jupyter internal port (already exposed by base image, but doesn't hurt)
EXPOSE 8888
# Default Caddy internal port (will be mapped by Vast.ai)
EXPOSE 11111

# Switch back to the default notebook user
USER ${NB_USER}

# Set working directory (usually /home/jovyan in base image)
WORKDIR /home/${NB_USER}

# Start supervisord as root (necessary to manage services like Caddy/KasmVNC)
# We override the base image's CMD which usually starts JupyterLab directly.
# Supervisor will now be responsible for starting JupyterLab, Caddy, KasmVNC.
USER root
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/RunViso-Supervisord.conf", "--nodaemon"]